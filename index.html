<!DOCTYPE html>
<meta charset="utf-8">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link href="style.css" rel="stylesheet">

<title>COVID-19 App</title>
<h1 class="title">COVID-19 Movement & Cases Tracker
  with Demographic Trends</h1></br>
<h4 class="title">Movement Index Data: <a href="https://help.cuebiq.com/hc/en-us/articles/360041285051-Reading-Cuebiq-s-COVID-19-Mobility-Insights">Cuebiq Mobility Index Analysis</a> uses phone data to measure the median distance traveled by all devices per county</h4> 
<h4 class="title">Cases Data: <a href="https://github.com/nytimes/covid-19-data">covid-19-data</a> is a New York Times GitHub repository that is updated each day with new cases and deaths by county</h4> 
<div class="row">
  <div class="column2" style="position: relative">
    <div id="slider_div">
      <h4 id="sliderinfo"></h4>
      <div class="row">
        <input type="range" min="1" max="7" value="4" class="slider" id="myRange"><div id="week"></div>
      </div>   
    </div>
    <h4 id="queryinfo"></h4>
    <div class="row" id="userbox">
        <div class="wrap">
          <div class="search">
              <input type="text" class="searchTerm" id="queriedCounty" placeholder="Enter a county (e.g. Dutchess)">
              <button type="submit" class="searchButton" onClick=handleQuery()>
                <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
        <div class="dropdown" id="dropdown">
          <button class="dropbtn" id="dropdown">State</button>
          <div class="dropdown-content">
          </div>
        </div>
     </div>
     <h4 id="querystateinfo"></h4>
     <div class="row" id="userbox">
      <div class="wrap">
        <div class="search">
            <input type="text" class="searchTerm" id="queriedState" placeholder="Enter a state (e.g. Massachusetts)">
            <button type="submit" class="searchButton" onClick=handleStateQuery()>
              <i class="fa fa-search"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="row" id="barchartdiv">
        <div id ="barchart"> </div>
    </div>   
    <div id="alertdiv" ></div>
  </div>
  <div class="column1" style="position: sticky; margin-top:10px;">
     <div id= "dem_options" style="position: relative; margin-bottom: -15%; margin-top: 3%;
             float: left; margin-left: 10%; visibility: hidden">
          <div id= "option_title"><h3 style="margin-bottom: 5px">Filter by Demographic</h3></div>
        <form id= "radio_options">
          <input type="radio" name="dem_radio" value="income" id="income_check" checked>Income
            <label class="dem_option" for="income_check"></label>
          <br>
          <input type="radio" name="dem_radio" value="vote" id="politics_check">Politics
            <label class="dem_option" for="politics_check"></label>
        </form>
    </div>
    <a href="#" id="toggleButton" value="MAP" class="myButton"
       style="margin-bottom: -5%; position: relative; z-index: 1;
             float: right; margin-right: 10%"style>Switch to Demographic Trends</a>
    <svg id="maps"></svg>
    <div style="margin-top:-10%" id="map-legend"></div>
  </div>
</div>

<script src="js/d3.v4.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<!-- <script src="js/bubbles.js"></script> -->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/0.10.0/lodash.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="js/d3-tip.js"></script>
<script type = "text/javascript" src="move_index.json"></script>
<script type = "text/javascript" src="us-county-cases.json"></script>
<script type = "text/javascript" src="./income_pos.json"></script>
<script type = "text/javascript" src="./bubble/pos-vote.json"></script>
<script type = "text/javascript" src="./demographic-data.json"></script>
<!-- <script type = "text/javascript" src="js/bubbles.js"></script> -->
<script type = "text/javascript" src="donut/donut.js"></script>
<script type = "text/javascript" src="donut/index.js"></script>
<script type = "text/javascript" src="js/d3-legend.min.js"> </script>
<script>

d3.select("#sliderinfo")
.text("Slide below to explore movement changes by week.")

d3.select("#queryinfo")
.text("Query a county or a state...")

d3.select("#querystateinfo")
// .text("Query a state below to prompt a donut chart breakdown of COVID-19 cases.")
// .text("OR")

var margin = {top: 10, left: 10, bottom: 10, right: 10}
  , width = $("body").width() / 1.1
  , width = width - margin.left - margin.right
  , mapRatio = .5
  , height = width * mapRatio;

var svg = d3.select("#maps")
    .style('width', width + 'px')
    .style('height', height + 'px')

d3.select("svg").style("cursor", "crosshair");

var move_dict = d3.map();
og_data.forEach( function(d){ move_dict.set( d.fips, d.move_index) });

var county_dict = d3.map();
var states_dict = d3.map();
var state_names_dict = d3.map();
var names_dict = {};
var names_and_county_dict = d3.map();
og_data.forEach( function(d){ 
  county_dict.set( d.fips, d.county);
  var countyState = d.county + " " + d.state;
  names_and_county_dict[d.fips] = d.county, d.state;
  names_dict[d.county] = d.fips;
  states_dict.set(d.fips, d.state);
  if (state_names_dict[d.state] == undefined)
    state_names_dict[d.state] = d.sab;
});

var cases_dict = d3.map();
var dates_dict = d3.map();
var deaths_dict = d3.map();
cases_data.forEach( function(d){ cases_dict.set( d.fips, d.cases); deaths_dict.set(d.fips, d.deaths); dates_dict.set(d.fips, d.dates); });

var weeks = ["Week of 2020-03-02", "Week of 2020-03-09", 
            "Week of 2020-03-16", "Week of 2020-03-23", 
            "Week of 2020-03-30", "Week of 2020-04-06", 
            "Week of 2020-04-13", "Week of 2020-04-20"];

// var quantize = d3.scaleQuantize()
//     .domain([0, 4])
//     .range(d3.range(5).map(function(i) { return "q" + i + "-9"; }));

var quantize = d3.scaleQuantize()
      .domain([0, 4])
      .range(d3.range(5).map(function(i) { 
          if (i == 0)
              return "#9adbb5";
          else if (i == 1)
              return "rgb(205, 235, 178)";
          else if (i == 2)
              return "#F6F5AE";
          else if (i == 3)
              return "rgb(253, 223, 158)";
          else
              return "rgb(211, 85, 65)";
      }))

var projection = d3.geoAlbersUsa()
    .scale(width)
    .translate([width / 2.4, height / 2]);

var path = d3.geoPath()
    .projection(projection);

var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-5, 0])
      .html(function(d) {
        // d3.select(".d3-tip").style("background-color", "rgba(214, 213, 213, 0.79)");
        var dataRow = county_dict.get(d.id)
           if (dataRow) {
               var val = document.getElementById("myRange").value;
               return "County: " + toTitleCase(county_dict.get(d.id)) + 
                      "<br>State: " + toTitleCase(states_dict.get(d.id)) + "<br>Move Index: " + move_dict.get(d.id)[val-1]
           } else {
               county_dict.get(d.id) + ": No data.";
           }
      })

svg.call(tip)

function in_move_range(move_index, d, val) {
  move_index = move_index.replace("<= 0.8", "0")
  move_index = move_index.replace("3 >=", "3.2")
  index = parseFloat(move_index)
  var move = move_dict.get(d)
  if (!move) {
      return 0.95;
  }
  move = move[val-1]
  if ((index == 3) && (move >= 3.8)) {
    return true
  }

  return ((move > index) && (move < index + 0.8))

}

function highlight_single(county) {
  console.log("here");
  console.log(county);
  var val = document.getElementById("myRange").value;
  if(document.getElementById("toggleButton").value=="MAP") {
    svg.selectAll(".counties path")
      .style("opacity", function(d) {
        return (county == d.id) ? 1.2 : 0.3
      })
      .style("stroke", function(d) {
        return county == d.id ? "black" : "transparent"
      });
  } else {
    var bubbles = d3.select(".bubble_svg")
    bubbles.selectAll("circle")
      .style("opacity", function(d) {
        return (county == d.fips) ? 0.75 : 0.2
      })
      .style("stroke", function(d) {
        return (county == d.fips) ? "black" : "transparent"
      })
  }
}


function highlight_move(move_index) {
  var val = document.getElementById("myRange").value;
  if(document.getElementById("toggleButton").value=="MAP") {
    svg.selectAll(".counties path")
      .style("opacity", function(d) {
        return in_move_range(move_index, d.id, val) ? 1.2 : 0.3
      })
      .style("stroke", function(d) {
        return in_move_range(move_index, d.id, val) ? "white" : "transparent"
      });
  } else {
    var bubbles = d3.select(".bubble_svg")
    bubbles.selectAll("circle")
      .style("opacity", function(d) {
        return in_move_range(move_index, d.fips, val) ? 0.75 : 0.2
      })
      .style("stroke", function(d) {
        return in_move_range(move_index, d.fips, val) ? "black" : "white"
      })
  }
}

function unhighlight() {
  console.log("testing");
  var val = document.getElementById("myRange").value;
  if(document.getElementById("toggleButton").value=="MAP") {
    svg.selectAll(".counties path")
      .style("opacity", 0.95)
      .style("stroke", "transparent")
  }
  else {
    var bubbles = d3.select(".bubble_svg")
    bubbles.selectAll("circle")
      .style("opacity", 0.75)
      .style("stroke", "transparent")

  }
}


var ordinal = d3.scaleOrdinal()
  .domain(["<= 0.8", "0.8", "1.6", "2.4", "3 >="])
  .range(["rgb(154,219,181)", "rgb(205, 235, 178)", "rgb(246,245,174)", 
          "rgb(253, 223, 158)", "rgb(211, 85, 65)"]);

var legend = d3.select("#map-legend").append("svg");

legend.append("g")
  .attr("class", "legend")
  .attr("transform", "translate(20,20)");

var move_legend = d3.legendColor()
  .shapeWidth(50)
  .orient('horizontal')
  .scale(ordinal)
  .title("Move Index (in miles)");

legend.select(".legend")
  .call(move_legend)

legend.selectAll("rect")
  .on("mouseover", highlight_move)
  .on("mouseout", unhighlight)



function toTitleCase(str) {
    return str.replace(/\w\S*/g, function(txt){
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
}

d3.queue()
    .defer(d3.json, "js/us.json")
    .await(ready);

function makeMap(us) {
  var val = document.getElementById("myRange").value;
  document.getElementById("week").innerHTML = weeks[val-1];

  var num_error_counties = 0;

  svg.append("g")
    .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
    .style("opacity", .95)
    .attr("fill", function(d) { 
      if (move_dict.get(d.id)) {
        return quantize(move_dict.get(d.id)[val-1])
      } else {
        num_error_counties += 1;
        return;
      }; })
      .attr("d", path)
      .on("mouseover", tip.show)
      .on("mouseout", tip.hide)
      .on("click", handleClick);

  function handleClick(d) {
    unhighlight();
    if (cases_dict.get(d.id)) {
      $( "#alertdiv" ).hide();
      $( "#barchartdiv" ).show();
      displayBar(d.id);
    }
    else {
      $( "#barchartdiv" ).hide( "slow" );
      $( "#alertdiv" ).show();
      upper = toTitleCase(county_dict.get(d.id));
      $( "#alertdiv" ).html("No case data for " + upper + " County");
    }
    highlight_single(d.id);
  }

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, 
        function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);

}


function displayBar(data) {
  $("#barchart").empty();
    var margin = {top: 30, right: 30, bottom: 50, left: 40};
    width = 250;
    height = 250;

    var bartip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-5, 0])
      .html(function(d, i) {
        return "Date: " + dates_dict.get(data)[i] 
        + "<br>Cases: " + cases_dict.get(data)[i] 
        + "<br>Deaths: " + deaths_dict.get(data)[i];
      })

    svg.call(bartip)

    // Bar chart SVG
    var svg2 = d3.select("#barchart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    var x = d3.scaleBand()
      .range([ 0, width])
      .domain(dates_dict.get(data))
      .padding(0.2);
      
    svg2.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).tickValues(x.domain().filter( (d,i) => !(i % 7) )))
      .selectAll("text")
        .attr("transform", "translate(-10,0)rotate(-45)")
        .style("text-anchor", "end")
        .style("font-size", "10px");

    // Add Y axis
    var cases = cases_dict.get(data);
    var max = 0;
    for (i = 0; i < cases.length; i++) {
      if (cases[i] > max)
        max = cases[i];
    }
    var y = d3.scaleLinear()
      .domain([0, max * 1.2])
      .range([ height, 0]);
    svg2.append("g")
      .call(d3.axisLeft(y));

    // Bars
    svg2.selectAll("mybar")
        .data(dates_dict.get(data))
        .enter()
        .append("rect")
          .attr("class", "cases")
          .attr("x", function(d) { 
            return x(d); 
            })
          .attr("width", x.bandwidth())
          .attr("fill", "#979797")
          .attr("height", function(d) { 
            return height - y(0); 
          })
          .attr("y", function(d) { 
            return y(0); 
          })
          .on("mouseover", bartip.show)
          .on("mouseout", bartip.hide)
      
    svg2.selectAll("mybar")
        .data(dates_dict.get(data))
        .enter()
        .append("rect")
          .attr("class", "deaths")
          .attr("x", function(d) { 
            return x(d); 
            })
          .attr("width", x.bandwidth())
          .attr("height", function(d) { 
            return height - y(0); 
          })
          .attr("y", function(d) { 
            return y(0); 
          })

    // Animation
    svg2.selectAll(".cases")
      .transition()
      .duration(200)
      .attr("y", function(d, i) { 
        return y(cases_dict.get(data)[i]); 
      })
      .attr("height", function(d, i) { 
        return height - y(cases_dict.get(data)[i]); 
      })
      .delay(function(d,i){
          return(i*50)
      })
      

    svg2.selectAll(".deaths")
      .transition()
      .duration(200)
      .attr("fill", "#c02c59")
      .attr("y", function(d, i) { 
        return y(deaths_dict.get(data)[i]); 
      })
      .attr("height", function(d, i) { 
        return height - y(deaths_dict.get(data)[i]); 
      })
      .delay(function(d,i){
          return(i*50)
      })

    // Capitalize each word of the county
    const county = toTitleCase(county_dict.get(data));
    const state = toTitleCase(states_dict.get(data));
    console.log(state);
    const title = county + ", " + state;
    
    // Title
    svg2.append("text")
      .attr("x", (width / 2))             
      .attr("text-anchor", "middle")  
      .style("font-size", "16px") 
      .text(title);
  }

function addDropdown(fips) {
  console.log("in dropdown", fips)
  $( ".dropbtn" ).show();
  s = "";
  var valid = new Array();
  for (i = 0; i < fips.length; i++) {
    if (cases_dict.get(fips[i])) {
      s += "<a href='#' id='county" + i + "'></a>";
      valid.push(i);
    }
  }
  console.log(valid.length + "valid fipses");
  document.getElementsByClassName("dropdown-content")[0].innerHTML = s;
  var curr_fips, curr_state;
  for (i = 0; i < valid.length; i++) {
    curr_fips = fips[valid[i]];
    curr_state = states_dict.get(curr_fips);
    $("#county" + valid[i]).html(curr_state);
  }

  $(document).ready(function() {
    $("a").click(function(event) {
      targ = event.target.id;
      console.log(fips[targ.slice(6)]);
      fips_q = fips[targ.slice(6)];
      highlight_single(fips_q);
      displayBar(fips_q);
    })
  })
}


function handleQuery() {
  $('#queriedCounty').blur();
  var query = $("#queriedCounty").val();
  $("#barchart").empty();
  var states_with_county = [];

  Object.keys(names_and_county_dict)
  .forEach(function eachKey(key) { 
    if (names_and_county_dict[key] == query.toLowerCase()) {
      states_with_county.push(key)
    }
  });

  if (states_with_county.length > 1) {
    $( "#alertdiv" ).hide();
    $( "#barchartdiv" ).show();
    addDropdown(states_with_county);
  }
  else {
    $("button#dropdown.dropbtn").hide();
    var fips_q = names_dict[query.toLowerCase()];
    highlight_single(fips_q);
    if (cases_dict.get(fips_q)) {
      $( "#alertdiv" ).hide();
      $( "#barchartdiv" ).show();
      displayBar(fips_q);
    }
    else {
      $( "#barchartdiv" ).hide( "slow" );
        // Capitalize each word of the county
        if (typeof(county_dict.get(query)) == "undefined") {
          $( "#alertdiv" ).show();
          $( "#alertdiv" ).html("County does not exist");
        }
        else {
          const upper = toTitleCase(county_dict.get(query))
          $( "#alertdiv" ).show();
          $( "#alertdiv" ).html("No case data for " + upper);
        }
    }
  }
}

function handleStateQuery() {
  console.log("entered");
  var query = $("#queriedState").val();
  console.log(state_names_dict[toTitleCase(query)]);
  if (state_names_dict[toTitleCase(query)]) {
    $("#alertdiv").hide();
    $("#barchart").empty();
    $("#barchartdiv").show();
    width = 320,
    height = 320;

    makeDonut(toTitleCase(query), width, height);
  }
  else {
    $( "#barchartdiv" ).hide( "slow" );
    $( "#alertdiv" ).show();
    $( "#alertdiv" ).html("State does not exist");
  }
}

$("#queriedCounty").on('keyup', function (e) {
    if (e.keyCode === 13) {
      e.preventDefault();
      document.getElementById('queriedState').value = "";
      handleQuery();
    }
});

$("#queriedState").on('keyup', function (e) {
    if (e.keyCode === 13) {
      e.preventDefault();
      document.getElementById('queriedCounty').value = "";
      handleStateQuery();
    }
});

$("#queriedCounty").on('focus', unhighlight);

pop_dict = d3.map()
dem_data.forEach( function(d){ 
  pop_dict.set( d.fips, d.pop_2019);
});


var county_dict = d3.map();
var sab_dict = d3.map();
og_data.forEach( function(d){ 
  county_dict.set( d.fips, d.county);
  sab_dict.set(d.fips, d.sab);
});

function get_rad_range(width) {
  if (width >= 900) {
    return [3,8]
  }
  else if (width >= 600) {
    return [2,5]
  }
  return [1.5,3]
}

function swapMap(us) {
  // bubbles are hidden, toggle to bubbles
  if(document.getElementById("toggleButton").value=="MAP"){
    document.getElementById("toggleButton").innerHTML = "Back to the map";
    document.getElementById("toggleButton").value="BUBBLE";
    $( "#dem_options" ).show();
    $("#bubbles").css("visibility", "visible"); 
    $("#dem_options").css("visibility", "visible")
    $("#maps").css("visibility", "hidden");
    $("#maps").empty();

    var val = document.getElementById("myRange").value;
    dem = $("input[name='dem_radio']:checked").val();
    make_bubbles_rep(us, val, dem)
  } 

  // map is hidden, toggle to map
  // else if(document.getElementById("toggleButton").value=="BUBBLE"){
  else {
    document.getElementById("toggleButton").value="MAP";
    $( "#dem_options" ).hide();
    document.getElementById("toggleButton").innerHTML = "Switch to Demographic Trends";
    $("#bubbles").css("visibility", "hidden"); 
    $("#maps").css("visibility", "visible");
    $("#maps").empty();
    console.log('making map')
    $("#dem_options").css("visibility", "hidden")
    
    makeMap(us);
  }
}

function change_move() {
    var val = document.getElementById("myRange").value;
    var t = d3.transition()
        .duration(750);

   if(document.getElementById("toggleButton").value=="MAP") {
    svg.selectAll("path")
      .transition(t)
        .attr("fill", function(d) { 
          if (move_dict.get(d.id)) {
            console.log(quantize(move_dict.get(d.id)[val-1]))
            return quantize(move_dict.get(d.id)[val-1])
          } });
   } else {

    var bubbles = d3.select(".bubble_svg")
    bubbles.selectAll("circle")
      .attr("move", function(d) {
        move_dict.get(d.fips)[val-1] });
  
    bubbles.selectAll("circle")
      .transition(t)
        .style("fill", function(d) { return quantize(move_dict.get(d.fips)[val-1]); });

  }
}

// to be used with swapmap to replace map with bubbles
function make_bubbles_rep(us, val, dem) {

  var margin = {top: 300, right: 250, bottom: 50, left: 50};
  d3.select(".bubble_svg").remove();
  var width = $("#maps").width()
  var height = $("#maps").height()

  pos = $("#maps").position().top;

  rad_range = get_rad_range(width)
  var max_income = 123000;
  var min_income = 18000;
  var max_pop = 1000000;
  var min_pop = 169;
  var min_vote = 0
  var max_vote = 1

  var min_max = {
    "income": {'min': min_income, 'max': max_income},
    "pop"   : {'min': min_pop, 'max': max_pop},
    "vote"  : {'min': min_vote, 'max': max_vote}
  }

  var dem_title = {
    "income": "Median Income",
    "vote"  : "% GOP Vote 2016",
  }

  var dem_label = {
    "income": "Income: $",
    "vote"  : "GOP Vote: %",
  }

  var dem_pos = {
    "income": income_pos,
    "vote"  : pos_vote
  }


  function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function get_x_value(data) {
    if (dem == "income") {
      return numberWithCommas(data.income)
    }
    return (dem == "vote") ? data.vote : data.cases
  }

  var move_dict = d3.map();
  og_data.forEach( function(d){ move_dict.set( d.fips, d.move_index) });

  var county_dict = d3.map();
  var sab_dict = d3.map();
  og_data.forEach( function(d){ 
    county_dict.set( d.fips, d.county);
    sab_dict.set(d.fips, d.sab);
  });

  var x = d3.scaleLinear()
    .domain( [min_max[dem].min, min_max[dem].max] )
    .range( [margin.left, width - margin.right] );

  var radquantize = d3.scaleQuantize()
      .domain([min_max['pop'].min, min_max['pop'].max])
      .range(rad_range)

  var xAxis = d3.axisBottom(x);

  var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-5, 0])
      .html(function(d) {
        return "County: " + toTitleCase(d.county) 
        + " (" + d.sab + ")<br>Move Index: " + d.move 
        + "<br>Population: " + numberWithCommas(d.pop) 
        + "<br>" + dem_label[dem] + get_x_value(d);
      })


  d3.json("./bubble/dem-data.json", function(error, data) {
    if (error) throw error;

  var bubbles = d3.select("#maps").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "bubble_svg")
    .attr("shape-rendering", "geometric-precision");

  $("#maps").css("visibility", "visible");

  bubbles.call(tip);

  var xAxisTitle = bubbles.append("text")
    .attr("class", "axisTitle")
    .text(dem_title[dem]);

  xAxisTitle
    .attr("x", width - xAxisTitle.node().getBBox().width - width/4.5)
    .attr("y", ( height/2) - xAxisTitle.node().getBBox().height - height/5)

  var quantize = d3.scaleQuantize()
      .domain([0, 4])
      .range(d3.range(5).map(function(i) { 
          if (i == 0)
              return "#9adbb5";
          else if (i == 1)
              return "rgb(205, 235, 178)";
          else if (i == 2)
              return "#F6F5AE";
          else if (i == 3)
              return "rgb(253, 223, 158)";
          else
              return "rgb(211, 85, 65)";
      }))

  var y_dict = d3.map();

  y_pos = dem_pos[dem]

  y_pos.forEach( function(d){ y_dict.set(d.fips, 250 - d.y )});

  function get_node_x(node) {
    if (dem == "income") {
      return node.median_income
    }
    return (dem == "vote") ? node.per_gop : node.cpc
  }
    //add other demographics!
    var nodes = data.map(function(node, index) {
      return {
        index: index,
        move: move_dict.get(node.fips)[val-1],
        fips: node.fips, 
        pop: node.pop_2019,
        income: node.median_income,
        county: node.county,
        sab: node.sab,
        vote: node.per_gop,
        x: x(get_node_x(node)),
        fx: x(get_node_x(node)),
        r: radquantize(node.pop_2019),
        y: y_dict.get(node.fips)
      };
    });


    var simulation = d3.forceSimulation(nodes)
      .force("x", d3.forceX(function(d) { return x(d.income); }).strength(1))
      .force("collide", d3.forceCollide().radius(function(d){ return d.r}))
      .force("manyBody", d3.forceManyBody().strength(-1))
      .tick();

    var circle = bubbles.selectAll("circle")
      .data(nodes)
      .enter().append("circle")
      .style("fill", function(d) { return quantize(d.move); })
      .attr("cx", function(d) { return d.x} )
      .attr("cy", function(d) { return d.y} )
      .attr("r", function(d) { return d.r} )
      .style("opacity", function(d) {
        return ((d.y + height/2) <= d.r || (d.y + height/2) >= (height - d.r)) ?  0 : 0.75})
      .attr("transform", "translate(0," + height/2 + ")")
      .on('mouseover', tip.show)
      .on('mouseout', tip.hide)
      .on('click', function(d) { clickBubbles(d.fips) })

    bubbles.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + (height/2)  + ")")
      .call(xAxis);
  });
}


function clickBubbles(d) {
    if (cases_dict.get(d)) {
      $( "#alertdiv" ).hide();
      $( "#barchartdiv" ).show();
      displayBar(d);
    }
    else {
      $( "#barchartdiv" ).hide( "slow" );
      // Capitalize each word of the county
      const upper = toTitleCase(county_dict.get(d))
      $( "#alertdiv" ).show();
      $( "#alertdiv" ).html("No case data for " + upper + " County");
    }
}


function ready(error, us) {
  if (error) throw error;
  $( "#alertdiv" ).hide();
  $( "#dem_options" ).hide();
  
  var slider = document.querySelector('input[type="range"]');
  var radio = document.querySelector('input[type="radio"]');
  var val = document.getElementById("myRange").value;
  var dem = $("input[name='dem_radio']:checked").val();

  slider.addEventListener('change', function () {
    if(document.getElementById("toggleButton").value=="MAP"){
      var val = document.getElementById("myRange").value;
      change_move()
      //makeMap(us);
    }
    else {
      var val = document.getElementById("myRange").value;
      dem = $("input[name='dem_radio']:checked").val();
      change_move()
      //make_bubbles_rep(us, val, dem)
    }
  });

  document.getElementById("toggleButton").addEventListener("click", 
    function(){
    swapMap(us);});

  window.addEventListener('keypress', function(e) {
      var keyCode = e.keyCode;
      var key = keyCode - 48
      if (key > 0 && key < 8) {
        document.getElementById("myRange").value = key;
        makeMap(us);
        dem = $("input[name='dem_radio']:checked").val();
        change_move()
      }
  });

  $('#radio_options').change(function(){
      dem = $("input[name='dem_radio']:checked").val();
      var val = document.getElementById("myRange").value;
      make_bubbles_rep(us, val, dem)
  });

  makeMap(us);
  swapMap(us);
  
  // make_bubbles_rep(us, val, dem)
  $( "#bubbles" ).hide();
  $("#bubbles").css("visibility", "hidden");
}

</script>